<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="bower_components/iron-form/iron-form.html">
<link rel="import" href="bower_components/iron-label/iron-label.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-card/paper-card.html">
<link rel="import" href="bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-input/paper-textarea.html">

<dom-module id="event-login-pw">
  <template>
    <style>
    :required:focus {
  box-shadow: 0  0 3px rgba(255,0,0,0.5); 
}
      :host {
        position: absolute;
        top: 77px;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgb(3, 140, 207);
        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1;
        color: var(--paper-purple-50);
        @apply(--layout);
        @apply(--layout-center-center);
      }
      :host([signed-in]) {
        opacity: 0;
        pointer-events: none;
      }
      paper-button > * {
        vertical-align: middle;
        text-transform: none;
      }
      ul {
        list-style: none;
        margin: 16px 0 0;
        padding: 0;
        text-align: center;
      }
      paper-button {
        display: inline-block;
        padding: 8px;
        text-transform: uppercase;
        text-decoration: none;
        font-weight: 500;
        background: rgb(3,155,229);
        color: white;
        border: 1px solid rgb(3,155,229);
        border-radius: 3px;
        font-size: 14px;
        box-shadow: 0 2px 5px 0 rgba(0,0,0,.26);
      }
      fieldset {
        display: block;
        border: 0;
      }
      h1 {
        white-space: initial;
        text-align: center;
      }
      paper-dialog {
      width: 700px;
      }
      label.style-scope.event-login-pw {
          margin-top: 10px;
          margin-bottom: 10px;
          display: block;
      }
      paper-dialog paper-button {
          width: 98%;
          text-align: center;
          margin: auto !important;
          display: block !important;
          float: none;
      }
      #signInRegistration {
          text-align: center;
      }

      #signInRegistration span {
          color: #039be5;
          cursor: pointer;
      }
      #personalInfoContainer {
          display: none;
      }
      #personalInfoContainer.active {
          display: block;
      }
      paper-checkbox#personalInfo {
          margin: 10px 0;
      }
      .regPasswords {
          width: 49%;
          float: left;
          margin: 0 1% 1% 0;
      }

      #regSecondPass {
          margin: 0 0 1% 1%;
      }
      fieldset.checkboxes {
          display: block;
          width: 46%;
          float: left;
      }
      #signInPw {
          font-size: 18px;
          padding: 0.5% 1.5%;
      }
      #registerButton {
        background: #ccc;
        border: 0;
      }
      #registerButton.passValid {
        background: rgb(3, 140, 207);
      }
      #loginButton {
        background: #ccc;
        border: 0;
      }
      #loginButton.passValid {
        background: rgb(3, 140, 207);
      }
      #invalidLogin {
          text-align: center;
          width: 100%;
          display: none;
          margin: 10px 0;
          font-size: 15px;
          color: #dd2c00;
      }
      #invalidLogin.active {
        display: block;
      }
    </style>
    <firebase-auth
      id="auth"
      app-name="event-planner"
      signed-in="{{signedIn}}"
      user="{{user}}">
    </firebase-auth>
    <paper-button id="signInPw" raised onclick="logIn.open()">Click here to begin</paper-button>
    <paper-dialog id="logIn" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
      <h1>Login to your Account</h1>
      <form is="iron-form" id="loginForm">
        <fieldset>
          <gold-email-input
              id="loginEmail"
              name="loginemail"
              label="Enter your email to login" 
              required 
              autocomplete="email" 
              aria-disabled="false" 
              bind-value="{[useremail]}" 
              auto-validate 
              error-message="Please enter a valid Email Address">
          </gold-email-input>
          <paper-input 
             type="password" 
             id="loginPassword" 
             label="Enter your password to login" 
             required
             name="loginpass"
             auto-validate
             value="{{passvalue}}"
             on-input="passchange"
             pattern="[[passvalidate]]"
             autocomplete="password" 
             min-length="8"
             error-message="Please enter a password matching the requirements"
             char-counter>
          </paper-input>
          <span id="invalidLogin">Invalid login credentials!</span>
        </fieldset>
        <paper-button on-tap="signIn" id="loginButton" disabled>Click here to Login</paper-button>
        <p id="signInRegistration">Don't have an Account? <span id="accountReg" onclick="registrationForm.open()">Click here to register</span></p>
      </form>
    </paper-dialog>
    <paper-dialog id="registrationForm" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
      <form is="iron-form" id="regForm">
        <fieldset>
         <h1>Register your Account</h1>
         <paper-input 
          type="text" 
          id="regUserName"
          name="nickname" 
          label="What would you like your nickname to be?"
          autocomplete="nickname"
          autofocus 
          required 
          pattern="[a-zA-Z]*\s*[a-zA-Z]*"
          minlength="2"
          auto-validate
          error-message="Please enter your name correctly - Only letters and a single space allowed">
         </paper-input>
         <gold-email-input
          id="regEmail"
          name="email"
          label="Please enter your email" 
          required 
          autocomplete="email" 
          bind-value="{[useremail]}" 
          auto-validate 
          error-message="Please enter a valid Email Address">
         </gold-email-input>
         <paper-input 
         type="password" 
         id="regPassword" 
         class="regPasswords"
         label="Please enter your password" 
         required 
         value="{{passvalue}}"
         on-input="passchange"
         pattern="[[passvalidate]]"
         autocomplete="password" 
         min-length="8"
         auto-validate
         error-message="Please enter a password matching the requirements"
         char-counter>
         </paper-input>
         <paper-input 
          type="password" 
          id="regSecondPass" 
          class="regPasswords"
          name="password-confirm" 
          label="Please confirm your password" 
          required 
          autocomplete="password" 
          value="{{passconfirmValue}}"
          on-input="passconfirmchange"
          pattern="[[passconfirm]]"
          auto-validate
          error-message="Make sure both passwords match"
          char-counter>
          </paper-input>
          <h3>Make sure your password fits all requirements:</h3>
        </fieldset>
        <fieldset class="checkboxes">
           <paper-checkbox
            id="passwordLower"
            invalid
            disabled>
            Must contain a lower case letter
           </paper-checkbox>
           <paper-checkbox
            id="passwordUpper"
            invalid
            disabled>
            Must contain an upper case letter
           </paper-checkbox>
           <paper-checkbox
            id="passwordNumber"
            invalid
            disabled>
            Must contain one number
           </paper-checkbox>
        </fieldset>
        <fieldset class="checkboxes">
          <paper-checkbox
            id="passwordSymbol"
            invalid
            disabled>
            Must contain at least one symbol
          </paper-checkbox>
          <paper-checkbox
            id="passwordMin"
            invalid
            disabled>
            Must contain at least 8 characters
          </paper-checkbox>
          <paper-checkbox
            id="passwordConfirmed"
            invalid
            disabled>
            Make sure both passwords are the same
          </paper-checkbox>
        </fieldset>
        <fieldset>
          <paper-checkbox id="personalInfo">
            <h2>Check to enter personal information (optional)</h2>
          </paper-checkbox>
        </fieldset>
        <fieldset id="personalInfoContainer">
          <paper-input
           id="reg-occupation" 
           name="occupation" 
           label="What's your occupation?" 
           autocomplete="organization-title">
          </paper-input>
          <paper-input 
           name="birthday"
           id="reg-birthday" 
           type="date" 
           label="When were you born?" 
           autocomplete="bday">
          </paper-input>
          <paper-input 
           name="appuse"
           id="reg-appuse" 
           type="text"
           list="uses" 
           label="How will you be using this application?">
          </paper-input>
          <datalist id="uses">
            <option value="Confidential"></option>
            <option value="Corporate"></option>
            <option value="Educational"></option>
            <option value="N/A"></option>
            <option value="Other"></option>
            <option value="Personal"></option>
            <option value="Private Events"></option>
            <option value="Recreation"></option>
          </datalist>
          <!--Make this a text box -->
          <paper-input
           name="streetaddress"
           id="diff-geo-address" 
           onFocus="geolocate" 
           type="text" 
           label="What's your street address?" 
           autocomplete="street-address">
          </paper-input>
        </fieldset>
        <paper-button on-tap="signIn" id="registerButton" disabled>Click here to create your account</paper-button>
    </form>
    <!-- field check and sign out buttons commented out until needed
     <ul>
         
        <li></li>
        <li><paper-button id="ccheck">Check</paper-button></li>
        <li><paper-button id="signout">Signout</paper-button></li>
      </ul>-->
  </paper-dialog>
  <script>
  /*=========================================================================== 

  Model

  ============================================================================*/


  /*=========================================================================== 

  View

  ============================================================================*/
    // selects view elements
    // logic button elements
    var rButton = document.getElementById("registerButton");
    var lButton = document.getElementById("loginButton");
    var soButton = document.getElementById("signout");
    var cButton = document.getElementById("ccheck");
    var lFormButton = document.getElementById("signInPw");
    var lFormRegButton = document.getElementById("accountReg");
    var pInfo = document.querySelector('#personalInfo');

    // handles login form values
    var rName = document.querySelector('#regUserName input');
    var rEmail = document.querySelector('#regEmail input');
    var rPass = document.querySelector('#regPassword input');
    var lEmail = document.querySelector('#loginEmail input');
    var lPass = document.querySelector('#loginPassword input');
    var rPassError = document.querySelector('#regPassword paper-input-container .add-on-content');
    var rSecondPass = document.querySelector('#regSecondPass input');

    // container elements
    var loginContainer = document.querySelector('#logIn');
    var regContainer = document.querySelector('#registrationForm');
    var pInfoContainer = document.querySelector('#personalInfoContainer');

    // these must be globalyl defined otherwise they will not authorize
    var email = rEmail;
    var password = rPass;

    // sets up the progress bar selector elements
    
    //sets up login progress bar selector 
    var progressBar = document.querySelector('paper-progress');

    // selectors for activation elements
    var loginProgressBar = document.querySelector('#progress-login');
    var regProgressBar = document.querySelector('#progress-reg');
    var regProgressBarOpt = document.querySelector('#progress-reg-optional');

    // login form inputs
    var inputs = [
      {
        selector: '#loginEmail',
        amount: 50
      }, {
        selector: '#loginPassword',
        amount: 50
      }
    ];

    // registration form inputs
    var inputsReg = [
      {
        selector: '#regUserName',
        amount: 25
      }, {
        selector: '#regEmail',
        amount: 25
      }, {
        selector: '#regPassword',
        amount: 25
      }, {
        selector: '#regSecondPass',
        amount: 25
      }    
    ];

    // registration form inputs
    var inputsRegOpt = [
      {
        selector: '#reg-occupation',
        amount: 25
      }, {
        selector: '#reg-birthday',
        amount: 25
      }, {
        selector: '#reg-appuse',
        amount: 25
      }, {
        selector: '#diff-geo-address',
        amount: 25
      }    
    ];

  /*=========================================================================== 

  Controller

  ============================================================================*/

    // login functions

    // event listeners for registration / login form
    // will be adding these as promises in the future
    // need to add each of these as a variable in each scope for these to work properly in EVENT LISTENERS
    // due to .value being assigned GLOBALLY and not being re-assigned once again within the function scope
    // should try refactoring this as an object later
    rButton.addEventListener("click",  function(){
      email = rEmail.value;
      password = rPass.value;
      firebase.auth().createUserWithEmailAndPassword(email, password)
      .then(
        console.log("SUCCESS! ACCOUNT CREATED!")
       )
      .catch(function(error) {
       console.log(error.code);
       console.log(error.message);
    });
      
      // need to find a way to AUTOMATICALLY login once user is subscribed 

    }); 

    // will need to add a promise here when this is refactored into the polymer base code

    // checks if checkbox is checked then activates container
    function checkboxActivate(checkButton, checkContainer) {
      checkButton.addEventListener('change', function () {
        if (this.active) {
          checkContainer.classList.add("active");
        } 
        else {
          checkContainer.classList.remove("active");
        }
      })
    }; 

    // checkboxActivate objects
    pCheckbox = new checkboxActivate(pInfo, pInfoContainer);

    // adds logic for progress bar display
    function ProgressCheck(button, container, aProgress, sProgress) {
      button.addEventListener("click", function(){
        container.classList.add('active');
        aProgress.classList.add('active');
        sProgress.classList.remove('active')
      });
    };

    // ProgressCheck objects
    logProgressCheck = new ProgressCheck(lFormButton,loginContainer,loginProgressBar,regProgressBar);
    regProgressCheck = new ProgressCheck(lFormRegButton,regContainer,regProgressBar,loginProgressBar);
    regProgressCheckOpt = new ProgressCheck(pInfo,regContainer,regProgressBarOpt,regProgressBar);

    /* check and logout button commented out until needed
    soButton.addEventListener("click", function(){
    firebase.auth().signOut().then(function() {
       console.log("Logged out!")
    }, function(error) {
       console.log(error.code);
       console.log(error.message);
    });
    });

    // check values
    cButton.addEventListener("click", function(){
      checkName = rName.value;
      checkEmail = rEmail.value;
      checkPass = rPass.value;
      console.log(checkName);
      console.log(checkEmail);
      console.log(checkPass);
      console.log("test");
      // need to find a way to AUTOMATICALLY login once user is subscribed
    });
    */

    // Progress Bar
    // Set up the logic to change the progress bar
    // originally derived from the instructor notes on : https://classroom.udacity.com/nanodegrees/nd802/parts/8021345401/modules/555574864975460/lessons/5243991811/concepts/54564686870923
    // initiates the progress tracker function

    function ProgressTracker (inputs, progressBar) {
      var self = this;
      this.progressBar = progressBar;
      this.inputs = inputs;

      this.inputs.forEach(function (input) {
        input.element = document.querySelector(input.selector);
        input.added = false;
        input.isValid = null;

        input.element.oninput = function () {
          input.isValid = self.determineStatus(input);
          self.adjustProgressIfNecessary(input);
        };
      });
    };

    ProgressTracker.prototype = {
      determineStatus: function (input) {
        var isValid = false;
        
        if (input.element.value.length > 0) {
          isValid = true;
        } else {
          isValid = false;
        }

        try {
          isValid = isValid && input.element.validate();
        } catch (e) {
          console.log(e);
        }
        return isValid;
      },
      adjustProgressIfNecessary: function (input) {
        var newAmount = this.progressBar.value;

        if (input.added && !input.isValid) {
          newAmount = newAmount - input.amount;
          input.added = false;
        } else if (!input.added && input.isValid) {
          newAmount = newAmount + input.amount;
          input.added = true;
        }
        this.progressBar.value = newAmount;
      }
    };

    // creates logic objects
    // login bar progress tracker
    var progressTracker = new ProgressTracker(inputs, progressBar);

    // registration progress tracker
    var progressBarReg = new ProgressTracker(inputsReg, regProgressBar);

    // registration optional progress tracker
    var progressBarRegOpt = new ProgressTracker(inputsRegOpt, regProgressBarOpt);
    // Registration form check (will have to be changed to fit both optional fields)
    // JavaScript code for the different address field activation and associated functions
    /* Need to fix this so that it shows up the reg bar and hides login bar when reg form active
    function regProgressCheck() {

    // Selects our Queries
      var checkReg = document.getElementById('registrationForm');

    // checks the form's paper-check element's state
      checkReg.addEventListener('change', function (e) {
      
    // if the check's parent element is 'active' run this if statement
        if (this.active) {
          regProgressContainer.classList.add("active");
          regProgressBar.classList.add("active");
          loginProgressBar.classList.add("inactive");
          
        } 

    // otherwise check for these classes and remove if present
        else {
          regProgressContainer.classList.remove("active");
          regProgressBar.classList.remove("active");
          loginProgressBar.classList.remove("inactive");
        }
      })
    } 
          //loads this function on window load
    window.addEventListener("load", regProgressCheck, false);

    // Different Address end
    // Progress Bar end */
  /*=========================================================================== 

  Controller end

  ============================================================================*/
  </script>

  </template>
  <script src="js/app.js"></script>
  <script>
    Polymer({
      is: 'event-login-pw',
      properties: {
        disabled: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        },
        signedIn: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        },
        passvalue: String,
        passvalidate: String,
        passconfirm: String,
        passconfirmvalue: String,
        valueState: {
          type: Object,
          value: {
          }
        }
      },
      signIn: function() {
      var email = this.$.loginEmail.value;
      var password = this.$.loginPassword.value;
      var invalLogin = this.$.invalidLogin;
      this.$.auth.signInWithEmailAndPassword(email, password)
      .catch(function(error){
        invalLogin.classList.add('active')
        console.log('Invalid login credentials!')
      });
      },
      signIn2: function signIn2() {
        this.fire('sign-in', null, { bubbles: true});
      },
      passchange: function (){
        this.valueState.passvalue = this.passValidation();
        this.passvalidate = this.valueState.passvalue ? this.passvalue : '';
        this.passconfirm = this.passvalue;
        this.$.regPassword.validate();
        this.$.loginPassword.validate();
      },
      passconfirmchange: function(){
        this.valueState.passconfirmvalue = this.passConfirmValidation();
        this.$.regSecondPass.validate();
      },

      passValidation: function (){
        var value = this.$.regPassword.value || this.$.loginPassword.value;
        var passMin = this.$.passwordMin.checked = value.length >= 8;
        var passLow = this.$.passwordLower.checked = /[a-z]/.test(value);
        var passUpp = this.$.passwordUpper.checked = /[A-Z]/.test(value);
        var passNum = this.$.passwordNumber.checked = /[0-9]/.test(value);
        var passSym = this.$.passwordSymbol.checked = /[\+\=\&\^\%\'$'\#\@\!]/.test(value);
        if (passMin && passLow && passUpp && passNum && passSym) {
          console.log('Passwords valid!');
          this.$.loginButton.classList.add('passValid');
          this.$.loginButton.removeAttribute('disabled');
        } else {
          console.log('Passwords invalid!');
          this.$.loginButton.classList.remove('passValid');
          this.$.loginButton.setAttribute('disabled', '');
        }
        return passMin && passLow && passUpp && passNum && passSym ;
        },

      passConfirmValidation: function (){
        var value = this.$.regPassword.value || this.$.loginPassword.value;
        var passconfirmValue = this.$.regSecondPass.value;
        var passwordsMatch = value === passconfirmValue;
        var passCon = this.$.passwordConfirmed.checked = passwordsMatch;
        if (passCon) {
            console.log('Passwords valid!');
            this.$.registerButton.classList.add('passValid');
            this.$.registerButton.removeAttribute('disabled');
        } else{
          console.log('Passwords invalid!');
          this.$.registerButton.classList.remove('passValid')
          this.$.registerButton.setAttribute('disabled','')
        }
        return passCon;
      },
      loginValidation: function (){
        if ($.loginPassword.value.isValid && $.loginEmail.value.isValid) {
          console.log('Login credentials valid!')
        } else {
          console.log('Login credentials invalid!')
        }
      }
    });
  </script>

</dom-module>
