<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">
<script src="https://www.gstatic.com/firebasejs/3.6.1/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCzhnmg4lArK8DY7jrk-BKMKi91p3Fw3hc",
    authDomain: "event-planner-e6ee3.firebaseapp.com",
    databaseURL: "https://event-planner-e6ee3.firebaseio.com",
    storageBucket: "event-planner-e6ee3.appspot.com",
    messagingSenderId: "838628542575"
  };
  firebase.initializeApp(config);
</script>
<dom-module id="event-login-pw">
  <template>
    <style>
      :host {
        position: absolute;
        top: 46px;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgb(3, 140, 207);
        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1;
        color: var(--paper-purple-50);
        @apply(--layout);
        @apply(--layout-center-center);
      }
      :host([signed-in]) {
        opacity: 0;
        pointer-events: none;
      }
      paper-button > * {
        vertical-align: middle;
        text-transform: none;
      }
      ul {
        list-style: none;
        margin: 16px 0 0;
        padding: 0;
        text-align: center;
      }
      li paper-button {
        display: inline-block;
        padding: 8px;
        text-transform: uppercase;
        text-decoration: none;
        font-weight: 500;
        background: rgb(3,155,229);
        color: white;
        border: 1px solid rgb(3,155,229);
        border-radius: 3px;
        font-size: 14px;
        box-shadow: 0 2px 5px 0 rgba(0,0,0,.26);
      }
      fieldset {
        display: block;
        border: 0;
      }
      form {
        width: 100%;
        max-width: 400px;
      }
      h2 {
        white-space: initial;
      }
    </style>
    <paper-button id="signIn2" raised onclick="animated.open()">Sign In</paper-button>
    <paper-dialog id="animated" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
      <form is="iron-form" id="form">
        <fieldset>
         <h2>Register your user account by adding the following information</h2>
         <paper-input id="reg-user-name" name="name" label="What's your Username?" inputElement="#test" required autocomplete="name" aria-disabled="false" autofocus bind-value="{[username]}" error-message="Please enter your name correctly"></paper-input>
         <paper-input id="reg-email" name="email" label="Please enter your email" required autocomplete="email" aria-disabled="false" bind-value="{[useremail]}" error-message="Please enter a valid Email Address"></paper-input>
         <paper-input id="reg-password" name="password" label="Please enter your password" required autocomplete="password" aria-disabled="false" bind-value="{[userpassword]}" pattern="" error-message="Please enter a valid password">
         </paper-input>
          <paper-input id="second-password" name="password-confirm" label="Please confirm your password" required autocomplete="password" aria-disabled="false"></paper-input>
        </fieldset>
        <fieldset id="diff-address-container">
          <h2>Enter your personal information (optional)</h2>
          <paper-input id="reg-occupation" name="name" label="What's your occupation?" autocomplete="name" aria-disabled="false" autovalidate></paper-input>
          <paper-input id="reg-birthday" type="text" label="When were you born?" autocomplete="street-address"></paper-input>
          <paper-input id="reg-address" onFocus="geolocate" type="text" label="Where do you live?" autocomplete="street-address"></paper-input>
          <!--Make this a text box -->
          <paper-input id="diff-geo-address" onFocus="geolocate" type="text-area" label="How will you be using this application?" autocomplete="street-address"></paper-input>
        </fieldset>
        <paper-button on-tap="_clearfields">Clear fields</paper-button>
        <paper-button on-tap="_register">Register</paper-button>
        <paper-button on-tap="_values">Check Values</paper-button>

    </form>
    <ul>
         <!-- refactor code here so that register triggers 'on tap' --> 
        <li><paper-button id="register">Register</paper-button></li>
        <li><paper-button on-tap="signIn2" id="login">Login</paper-button>
        <li><paper-button id="ccheck">Check</paper-button></li>
        <li><paper-button id="signout">Signout</paper-button></li>
      </ul>
  </paper-dialog>
  <script>
  /*=========================================================================== 

  Model

  ============================================================================*/
    // this will be replaced when the global application callback is in place
    var ref = Firebase('https://event-planner-e6ee3.firebaseio.com');

  /*=========================================================================== 

  View

  ============================================================================*/
    // selects view elements
    var rButton = document.getElementById("register");
    var lButton = document.getElementById("login");
    var soButton = document.getElementById("signout");
    var cButton = document.getElementById("ccheck");

    //handles login form values
    var rName = document.querySelector('#reg-user-name input');
    var rEmail = document.querySelector('#reg-email input');
    var rPass = document.querySelector('#reg-password input');
    var rSecondPass = document.querySelector('#second-password input');

    // these must be globalyl defined otherwise they will not authorize
    var email = rEmail;
    var password = rPass;

  /*=========================================================================== 

  Controller

  ============================================================================*/

    // login functions

    // event listeners for registration / login form
    // will be adding these as promises in the future
    // need to add each of these as a variable in each scope for these to work properly in EVENT LISTENERS
    // due to .value being assigned GLOBALLY and not being re-assigned once again within the function scope
    rButton.addEventListener("click", /* function(){
      Commented out for now to check validation 
     email = rEmail.value;
      password = rPass.value;
      firebase.auth().createUserWithEmailAndPassword(email, password).catch(function(error) {
       console.log(error.code);
       console.log(error.message);
    });
      console.log("SUCCESS! ACCOUNT CREATED!");
      // need to find a way to AUTOMATICALLY login once user is subscribed 

    }*/
    formValidation());   

    lButton.addEventListener("click", function(){
      email = rEmail.value;
      password = rPass.value;
    firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
       console.log(error.code);
       console.log(error.message);
    });
       console.log("SUCCESS! LOGGED IN!");
    });

    soButton.addEventListener("click", function(){
    firebase.auth().signOut().then(function() {
       console.log("Logged out!")
    }, function(error) {
       console.log(error.code);
       console.log(error.message);
    });
    });

    // check values
    cButton.addEventListener("click", function(){
      checkName = rName.value;
      checkEmail = rEmail.value;
      checkPass = rPass.value;
      console.log(checkName);
      console.log(checkEmail);
      console.log(checkPass);
      console.log("test");
      // need to find a way to AUTOMATICALLY login once user is subscribed
    });

        /*=========================================================================== 

    Validation

    ============================================================================*/
     // constructor object to join form validation issues
    function checkErrors(){

      // creates the array storing validation errors
      this.errors = [];

    }

    checkErrors.prototype = {

      // pushes all found errors into the errors array
      add: function (error){
        this.errors.push(error)
      },

      // checks all found errors together
      check: function() {
        var valmessage = "";
        switch (this.errors.length) {
          case 0:
          break;
          case 1:
          valmessage = "Please review the following error: " + this.errors[0];
          break;
          default:
          valmessage = "Please review the following errors: " + this.issues.join(" ,");
          break;
        }
        return valmessage;
      }
    }; 
    // begins checking registration form validation
    rButton.onclick = function (){

      // sets the variables to check input values
      var name = rName.value;
      var email = rEmail.value;
      var password = rPass.value;
      var secondPassword = rSecondPass.value;

      // checks for issues for each input 
      var nameErrors = new checkErrors();
      var emailErrors = new checkErrors();
      var passwordErrors = new checkErrors();
      var secondPasswordErrors = new checkErrors();

      // checks name validation
      // IMPORTANT to reuse validation in different places, try to add the arguments for each check function to the input value and the error object, for example:
      // function checkName(input, errorObject);
      // or more specific example for name check: function checkName(name, nameErrors);
      // this way, the functions can be re-used for the events
      // Test this method out after checking that validation does actually work
      function checkName() {
        // if password length is less than 16
        if (name.length < 2) {

        // add the following message to his objects issues array
          nameErrors.add("fewer than 2 characters");
        } 
        // if name length is over 100
        else if (name.length > 40) {
          nameErrors.add("greater than 40 characters");
        }
        // if name value does not (or !) match one symbol
        if (name.match(/[\!\@\#\$\%\^\&\*]/g)) {
          nameErrors.add("must not contain a symbol (!, @, #, $, %, ^, &, *)");
        }
        // if name has a number
        if (name.match(/\d/g)) {
          nameErrors.add("must not contain a number");
        }
        // if password does not have alphanumerical characters, numbers, or the allowed symbols
        var illegalChars = name.match(/[^A-z0-9\!\@\#\$\%\^\&\*]/g)

        if (illegalChars) {
        // adds a function for each found illegal character, and adds it to the issues array, which then returns an issue message for each illegal charcater
          illegalChars.forEach(function (illegalChar) {
            nameErrors.add("includes illegal character: " + illegalChar);
          });
        }
        };

      // checks email validation
      function checkEmail() {
        // if email length is less than 16
        if (email.length < 7) {

        // add the following message to his objects issues array
          emailErrors.add("fewer than 8 characters");
        } 
        // if email value does not match @ symbol
        if (!email.match(/\@/g)) {
          emailErrors.add("must contain @ symbol");
        }
        // if password does not have a lowercase later
        if (!email.match(/\./g)) {
          emailErrors.add("must contain domain identifier (.com, .ca, .org, etc.)");
        }
        // if password does not have alphanumerical characters, numbers, or the allowed symbols
        var illegalChars = email.match(/[^A-z\@\.]/g)

        if (illegalChars) {
        // adds a function for each found illegal character, and adds it to the issues array, which then returns an issue message for each illegal charcater
          illegalChars.forEach(function (illegalChar) {
            emailErrors.add("includes illegal character: " + illegalChar);
          });
        }
      };

      // checks password validation 
      function checkPassword() {
        // if password length is less than 16
        if (password.length < 8) {

        // add the following message to his objects issues array
          passwordErrors.add("fewer than 8 characters");
        } 
        // if password length is over 100
        else if (password.length > 30) {
          passwordErrors.add("greater than 30 characters");
        }
        // if password value does not (or !) match one symbol
        if (!password.match(/[\!\@\#\$\%\^\&\*]/g)) {
          passwordErrors.add("must contain a symbol (!, @, #, $, %, ^, &, *)");
        }
        // if password does not have a number
        if (!password.match(/\d/g)) {
          passwordErrors.add("must contain a number");
        }
        // if password does not have a lowercase later
        if (!password.match(/[a-z]/g)) {
          passwordErrors.add("must contain a lowercase letter");
        }
        // if password does not have an uppercase letter
        if (!password.match(/[A-Z]/g)) {
          passwordErrors.add("must contain an uppercase letter");
        }
        // if password does not have alphanumerical characters, numbers, or the allowed symbols
        var illegalChars = password.match(/[^A-z0-9\!\@\#\$\%\^\&\*]/g)

        if (illegalChars) {
        // adds a function for each found illegal character, and adds it to the issues array, which then returns an issue message for each illegal charcater
          illegalChars.forEach(function (illegalChar) {
            passwordErrors.add("includes illegal character: " + illegalChar);
          });
        }
      };


      // retrieves all issues 
      var nameErrorsCheck = nameErrors.check()
      var emailErrorsCheck = emailErrors.check()
      var passwordErrorsCheck = passwordErrors.check()
      var secondPasswordErrorsCheck = secondPasswordErrors.check()

      // sets the custom validity for each of the input's errors
      rName.setCustomValidity(nameErrorsCheck);
      rEmail.setCustomValidity(emailErrorsCheck);
      rPass.setCustomValidity(passwordErrorsCheck);
      rSecondPass.setCustomValidity(secondPasswordErrorsCheck);

      // checks to confirm all inputs are validated
      if (nameErrorsCheck.length + emailErrorsCheck.length + passwordErrorsCheck.length + secondPasswordErrorsCheck.length === 0) {
        alert("Your account has been created!");
      }
    };

    
    /*=========================================================================== 

    Validation end 

    ============================================================================*/
  </script>
  </template>
  <script>
    Polymer({
      is: 'event-login-pw',
      properties: {
        disabled: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        },
        signedIn: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        }
      },
      signIn: function() {
        this.fire('sign-in', null, { bubbles: true});
      },
      signIn2: function() {
        this.fire('sign-in', null, { bubbles: true});
      }
    });
  </script>

</dom-module>
